# config.yaml
# This is the main configuration file for the mSWE-GNN Adforce pipeline.
# It is designed to be the "single source of truth" for training,
# and is loaded by adforce_main.py using Hydra.

defaults:
  - _self_            # Loads this file first
  - machine: jasmin      # Loads the default machine config (e.g., conf/machine/mac.yaml)

# --- 1. Top-Level Paths (to be defined/overridden by machine configs) ---
# We provide sensible defaults, but expect machine configs to set these.
paths:
  raw_dir: /Users/simon/swegnn_5sec/
  processed_dir: /Users/simon/mSWE-GNN/test/processed_data/
  checkpoint_dir: /Users/simon/mSWE-GNN/test/checkpoints/
  wandb_dir: /Users/simon/mSWE-GNN/test/wandb_logs/


# --- 2. Machine & Environment ---
# These paths are now *references* to the 'paths' block above
machine:
  data_dir: ${paths.raw_dir}
  checkpoint_dir: ${paths.checkpoint_dir}
  wandb_dir: ${paths.wandb_dir}
  
  # Compute settings
  accelerator: "gpu" # or "cpu"
  devices: 1
  num_workers: 4


# --- 3. Data Parameters ---
# Controls data loading, processing, and splitting
data_params:
  # --- This is the new, critical block for splitting ---
  split_files:
    # Path to the YAML file containing the list of *training* basenames
    train: conf/train.yaml
    # Path to the YAML file containing the list of *validation* basenames
    val: conf/val.yaml
    # Path to the YAML file containing the list of *test* basenames
    test: conf/test.yaml

  # --- These paths are now references ---
  train_root_path: ${paths.processed_dir}/train/
  val_root_path: ${paths.processed_dir}/val/
  scaling_stats_path: ${paths.processed_dir}/scaling_stats.yaml
  
  # Set to true to force re-computation of stats from the training files.
  # Set to false to load from scaling_stats_path.
  compute_scaling: true


# --- 4. Feature Configuration ---
# The "single source of truth" for all model features.
features:
  static:
    - DEM
    - slopex
    - slopey
    - area
  edge:
    - face_distance
    - edge_slope
  forcing:
    - P
    - WX
    - WY
  targets:
    - WD
    - VX
    - VY
  state:
    - WD
    - VX
    - VY
  derived_state:
    - name: SSH
      op: add
      args:
        - WD
        - DEM


# --- 5. Model Parameters ---
model_params:
  previous_t: 1
  model_type: GNN


# --- 6. Model Architecture ---
models:
  seed: 42
  type_gnn: SWEGNN
  hid_features: 64
  mlp_layers: 2
  K: 3
  normalize: true
  gnn_activation: tanh
  edge_mlp: true
  with_gradient: true


# --- 7. Training Parameters ---
trainer_options:
  batch_size: 8
  max_epochs: 100
  precision: "bf16-mixed"
  type_loss: "RMSE"
  only_where_water: true
  velocity_scaler: 1.0


# --- 8. Learning Rate & Optimizer ---
lr_info:
  learning_rate: 0.001
  weight_decay: 0.0001
  use_lr_scheduler: true
  step_size: 20
  gamma: 0.5


# --- 9. Logging (Weights & Biases) ---
wandb:
  project: "mswe-gnn-adforce"
  name: "GNN-64hid-3K-SSH_derived"
  entity: "sdat2"
